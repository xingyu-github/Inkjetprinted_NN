%% Here the fitting criterion is implemented. 
% This is an example of RMSE criterion

function out = mse(input_parameters)

% voltage, current, and time vector of the reference data.
t_ref=[0.800000000000000;1.60000000000000;2.40000000000000;3.20000000000000;4;4.80000000000000;5.60000000000000;6.40000000000000;7.20000000000000;8;8.80000000000000;9.60000000000000;10.4000000000000;11.2000000000000;12;12.8000000000000;13.6000000000000;14.4000000000000;15.2000000000000;16;16.8000000000000;17.6000000000000;18.4000000000000;19.2000000000000;20;20.8000000000000;21.6000000000000;22.4000000000000;23.2000000000000;24;24.8000000000000;25.6000000000000;26.4000000000000;27.2000000000000;28;28.8000000000000;29.6000000000000;30.4000000000000;31.2000000000000;32;32.8000000000000;33.6000000000000;34.4000000000000;35.2000000000000;36;36.8000000000000;37.6000000000000;38.4000000000000;39.2000000000000;40;40.8000000000000;41.6000000000000;42.4000000000000;43.2000000000000;44;44.8000000000000;45.6000000000000;46.4000000000000;47.2000000000000;48;48.8000000000000;49.6000000000000;50.4000000000000;51.2000000000000;52;52.8000000000000;53.6000000000000;54.4000000000000;55.2000000000000;56;56.8000000000000;57.6000000000000;58.4000000000000;59.2000000000000;60;60.8000000000000;61.6000000000000;62.4000000000000;63.2000000000000;64;64.8000000000000;65.6000000000000;66.4000000000000;67.2000000000000;68;68.8000000000000;69.6000000000000;70.4000000000000;71.2000000000000;72;72.8000000000000;73.6000000000000;74.4000000000000;75.2000000000000;76;76.8000000000000;77.6000000000000;78.4000000000000;79.2000000000000;80];
v_ref=[-0.0999420000000000;-0.0962680000000000;-0.0922030000000000;-0.0882160000000000;-0.0842300000000000;-0.0801650000000000;-0.0761000000000000;-0.0721140000000000;-0.0682050000000000;-0.0641410000000000;-0.0599980000000000;-0.0560890000000000;-0.0521030000000000;-0.0480380000000000;-0.0440510000000000;-0.0400650000000000;-0.0360780000000000;-0.0320130000000000;-0.0281050000000000;-0.0241180000000000;-0.0200540000000000;-0.0160670000000000;-0.0120020000000000;-0.00801560000000000;-0.00395080000000000;-0.000355060000000000;0.00347520000000000;0.00808710000000000;0.0120740000000000;0.0161380000000000;0.0200470000000000;0.0241120000000000;0.0280980000000000;0.0321630000000000;0.0362280000000000;0.0401360000000000;0.0442010000000000;0.0481090000000000;0.0521740000000000;0.0561610000000000;0.0602250000000000;0.0640560000000000;0.0681210000000000;0.0721070000000000;0.0761720000000000;0.0802370000000000;0.0843010000000000;0.0882880000000000;0.0921960000000000;0.0963390000000000;0.0988410000000000;0.0965740000000000;0.0925090000000000;0.0885220000000000;0.0844580000000000;0.0804710000000000;0.0765630000000000;0.0724200000000000;0.0685110000000000;0.0645250000000000;0.0604600000000000;0.0565520000000000;0.0524090000000000;0.0484220000000000;0.0443570000000000;0.0404490000000000;0.0364620000000000;0.0323190000000000;0.0283330000000000;0.0243460000000000;0.0203600000000000;0.0162950000000000;0.0123080000000000;0.00832160000000000;0.00433500000000000;0.000426630000000000;-0.00363810000000000;-0.00770290000000000;-0.0116890000000000;-0.0157540000000000;-0.0198190000000000;-0.0238060000000000;-0.0277920000000000;-0.0318570000000000;-0.0358440000000000;-0.0399080000000000;-0.0439730000000000;-0.0479600000000000;-0.0520240000000000;-0.0560110000000000;-0.0599190000000000;-0.0639060000000000;-0.0679710000000000;-0.0718790000000000;-0.0758660000000000;-0.0799310000000000;-0.0839170000000000;-0.0879040000000000;-0.0919680000000000;-0.0960330000000000];
i_ref=[-2.78100000000000e-05;-2.75320000000000e-05;-2.54620000000000e-05;-2.39170000000000e-05;-2.30210000000000e-05;-2.19710000000000e-05;-2.04260000000000e-05;-1.90350000000000e-05;-1.79540000000000e-05;-1.65640000000000e-05;-1.58220000000000e-05;-1.44630000000000e-05;-1.33200000000000e-05;-1.21460000000000e-05;-1.11570000000000e-05;-1.01370000000000e-05;-8.80900000000000e-06;-7.84450000000000e-06;-6.96570000000000e-06;-6.03930000000000e-06;-5.07800000000000e-06;-4.18330000000000e-06;-3.17120000000000e-06;-2.15600000000000e-06;-1.09950000000000e-06;-1.02780000000000e-07;9.84030000000000e-07;2.38400000000000e-06;3.64600000000000e-06;4.92530000000000e-06;6.29010000000000e-06;7.70720000000000e-06;9.35080000000000e-06;1.09530000000000e-05;1.27270000000000e-05;1.47890000000000e-05;1.69720000000000e-05;2.02010000000000e-05;2.38370000000000e-05;2.88180000000000e-05;3.63310000000000e-05;4.64170000000000e-05;5.93360000000000e-05;7.75400000000000e-05;9.87590000000000e-05;0.000144740000000000;0.000167980000000000;0.000199800000000000;0.000241510000000000;0.000291710000000000;0.000326130000000000;0.000353410000000000;0.000359620000000000;0.000361570000000000;0.000355950000000000;0.000345660000000000;0.000332870000000000;0.000318780000000000;0.000302650000000000;0.000286090000000000;0.000267680000000000;0.000249880000000000;0.000231370000000000;0.000212810000000000;0.000194330000000000;0.000175760000000000;0.000157350000000000;0.000139060000000000;0.000121110000000000;0.000103160000000000;8.53610000000000e-05;6.79360000000000e-05;5.05110000000000e-05;3.34560000000000e-05;1.67110000000000e-05;1.08010000000000e-06;-1.47770000000000e-05;-2.97990000000000e-05;-4.38160000000000e-05;-5.66460000000000e-05;-6.74110000000000e-05;-7.59610000000000e-05;-8.07700000000000e-05;-8.16680000000000e-05;-7.84580000000000e-05;-7.00880000000000e-05;-5.73760000000000e-05;-4.42880000000000e-05;-3.25940000000000e-05;-2.58270000000000e-05;-2.17440000000000e-05;-2.02530000000000e-05;-1.97890000000000e-05;-2.04870000000000e-05;-2.13660000000000e-05;-2.29910000000000e-05;-2.54210000000000e-05;-2.80350000000000e-05;-3.00340000000000e-05;-3.26070000000000e-05];

% Define the parameters of the model.
D       =  1e-7;% Device length 
x_init  =  0;  % ;init value for state variable [0,D]
iv      = 1;  % I-V relationship, linear = 0, exponential=1.

% Define your input
v_input     = v_ref; 
t_vec       = t_ref;

N=length(t_vec);

% Run the desired model in this case the vteam_op_model is used.
[v_model,i_model,~]=vteam_op_model(v_input,t_vec,x_init,iv,input_parameters);

% The output is the RMSE in this case. The algorithms will try to minimize
% this output using a pointer the function mse using @mse in the run script
out     =   sqrt(( (sum((v_model-v_ref).^2)/sum(v_ref.^2)) +...
            (sum((i_model-i_ref).^2)/sum(i_ref.^2)) )/N);

end